/* ========== /_icon.scss ========== */
//
// Copyright 2022 Google LLC
// SPDX-License-Identifier: Apache-2.0
//

@forward './internal/icon' show theme;


// ========== /icon.ts ==========
/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import {CSSResultOrNative} from 'lit';
import {customElement} from 'lit/decorators.js';

import {Icon} from './internal/icon.js';
import {styles} from './internal/icon-styles.js';

declare global {
  interface HTMLElementTagNameMap {
    'md-icon': MdIcon;
  }
}

/**
 * @final
 * @suppress {visibility}
 */
@customElement('md-icon')
export class MdIcon extends Icon {
  /** @nocollapse */
  static override styles: CSSResultOrNative[] = [styles];
}


// ========== /icon_test.ts ==========
/**
 * @license
 * Copyright 2023 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

// import 'jasmine'; (google3-only)
import './icon.js';

import {html} from 'lit';

import {Environment} from '../testing/environment.js';
import {createTokenTests} from '../testing/tokens.js';

import {MdIcon} from './icon.js';

describe('<md-icon>', () => {
  const env = new Environment();

  describe('.styles', () => {
    createTokenTests(MdIcon.styles);
  });

  describe('accessiblity', () => {
    it('sets aria-hidden to true by default', async () => {
      const root = env.render(html` <md-icon>check</md-icon>`);
      const icon = root.querySelector('md-icon')!;

      await env.waitForStability();

      expect(icon.getAttribute('aria-hidden')).toBe('true');
    });

    it('sets aria-hidden is removed when initalized as false', async () => {
      const root = env.render(html` <md-icon aria-hidden="false"
        >check</md-icon
      >`);
      const icon = root.querySelector('md-icon')!;

      await env.waitForStability();

      expect(icon.hasAttribute('aria-hidden')).toBe(false);
    });

    it('allows overriding aria-hidden after first render', async () => {
      const root = env.render(html` <md-icon>check</md-icon>`);
      const icon = root.querySelector('md-icon')!;

      await env.waitForStability();

      expect(icon.getAttribute('aria-hidden')).toBe('true');

      icon.removeAttribute('aria-hidden');
      await env.waitForStability();

      expect(icon.hasAttribute('aria-hidden')).toBe(false);
    });

    it('overrides invalid aria-hidden values to true', async () => {
      const root =
        env.render(html` <!-- @ts-ignore:disable-next-line:no-incompatible-type-binding -->
          <md-icon aria-hidden="foo">check</md-icon>`);
      const icon = root.querySelector('md-icon')!;

      await env.waitForStability();

      expect(icon.getAttribute('aria-hidden')).toBe('true');
    });
  });
});


/* ========== /internal/_icon.scss ========== */
//
// Copyright 2022 Google LLC
// SPDX-License-Identifier: Apache-2.0
//

// go/keep-sorted start
@use 'sass:list';
@use 'sass:map';
// go/keep-sorted end
// go/keep-sorted start
@use '../../tokens';
// go/keep-sorted end

@mixin theme($tokens) {
  $supported-tokens: tokens.$md-comp-icon-supported-tokens;

  @each $token, $value in $tokens {
    @if list.index($supported-tokens, $token) == null {
      @error 'Token `#{$token}` is not a supported token.';
    }

    @if $value {
      --md-icon-#{$token}: #{$value};
    }
  }
}

@mixin styles() {
  $tokens: tokens.md-comp-icon-values();

  :host {
    font-size: map.get($tokens, 'size');
    width: map.get($tokens, 'size');
    height: map.get($tokens, 'size');
    color: inherit;
    font-variation-settings: inherit;
    font-weight: 400;
    font-family: map.get($tokens, 'font');
    display: inline-flex;
    font-style: normal;
    place-items: center;
    place-content: center;
    line-height: 1;
    // Avoid displaying overflowing text if font ligatures have not loaded.
    overflow: hidden;
    // Changing the letter-spacing for WCAG text spacing compliance will shift
    // around font ligature icons, so we revert that to normal. Note: some a11y
    // tools use `!important` style injection and may see shifting icons. Actual
    // text spacing override implementations in projects should not set
    // `letter-spacing` on icons, or revert it with a `text-indent` of the same
    // size.
    letter-spacing: normal;
    text-transform: none;
    user-select: none;
    white-space: nowrap;
    word-wrap: normal;
    // Prevent icons from shrinking when placed in a flex container.
    flex-shrink: 0;

    /* Support for all WebKit browsers. */
    -webkit-font-smoothing: antialiased;
    /* Support for Safari and Chrome. */
    text-rendering: optimizeLegibility;
    /* Support for Firefox. */
    -moz-osx-font-smoothing: grayscale;
  }

  ::slotted(svg) {
    fill: currentColor;
  }

  ::slotted(*) {
    height: 100%;
    width: 100%;
  }
}


/* ========== /internal/icon-styles.scss ========== */
//
// Copyright 2022 Google LLC
// SPDX-License-Identifier: Apache-2.0
//

// go/keep-sorted start
@use './icon';
// go/keep-sorted end

@include icon.styles;


// ========== /internal/icon.ts ==========
/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */

import {html, LitElement} from 'lit';

/**
 * TODO(b/265336902): add docs
 */
export class Icon extends LitElement {
  protected override render() {
    return html`<slot></slot>`;
  }

  override connectedCallback() {
    super.connectedCallback();
    const ariaHidden = this.getAttribute('aria-hidden');
    if (ariaHidden === 'false') {
      // Allow the user to set `aria-hidden="false"` to create an icon that is
      // announced by screenreaders.
      this.removeAttribute('aria-hidden');
      return;
    }

    // Needed for VoiceOver, which will create a "group" if the element is a
    // sibling to other content.
    this.setAttribute('aria-hidden', 'true');
  }
}